<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>P4: Pulsador D3</title>
    <style>
        /* ESTILOS ROBUSTOS v3.34 */
        :root { 
            --bg-body:#1a1a2e; --bg-card:#16213e; --text-main:#fff; --text-accent:#e94560; 
            --led-off:#444; --led-yellow:#ffeb3b; 
            --terminal-bg:#0f0f1a; --terminal-text:#00ff00; 
        }
        body { font-family:'Segoe UI', sans-serif; background:var(--bg-body); color:var(--text-main); text-align:center; padding:20px; }
        h1 { border-bottom:2px solid var(--text-accent); display:inline-block; padding-bottom:10px; }
        
        .grid-container { display:flex; justify-content:center; gap:30px; margin-top:30px; flex-wrap:wrap; }
        .card { background:var(--bg-card); border:1px solid #333; border-radius:12px; padding:20px; width:300px; display:flex; flex-direction:column; align-items:center; }
        
        button.btn-connect { background:var(--text-accent); color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold; width:100%; margin-bottom:10px; font-size:1rem; }
        button.btn-connect:hover { background: #ff577f; }

        /* Terminal infalible */
        #terminal { 
            background:var(--terminal-bg); color:var(--terminal-text); 
            height:150px; width:100%; overflow-y:auto; 
            font-family:'Courier New', monospace; font-size: 0.9rem; 
            text-align:left; padding:10px; border:1px solid #555; 
            white-space: pre-wrap; 
        }

        /* Indicador Visual */
        .led-indicator { width:60px; height:60px; border-radius:50%; background:var(--led-off); border:3px solid #666; transition:0.1s; margin:20px; box-shadow:inset 0 0 10px #000; }
        .led-indicator.active { background:var(--led-yellow); box-shadow:0 0 25px var(--led-yellow); border-color:#fff; transform: scale(1.1); }
    </style>
</head>
<body>

    <h1>Pr√°ctica 4: Pulsador D3</h1>

    <div class="grid-container">
        <div class="card">
            <h3>üîå Conexi√≥n USB</h3>
            <button class="btn-connect" onclick="conectarArduino()">üîå CONECTAR</button>
            <div id="terminal">Esperando pulsaci√≥n...</div>
        </div>

        <div class="card">
            <h3>üîò Pulsador (D3)</h3>
            <div id="visual-btn" class="led-indicator"></div>
            <p>Pulsa el bot√≥n <strong>D3</strong></p>
        </div>
    </div>

    <script>
        let port, reader;

        // --- 1. CONEXI√ìN ---
        async function conectarArduino() {
            if (!("serial" in navigator)) return log("‚ùå Navegador no compatible.");
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                const decoder = new TextDecoderStream(); 
                port.readable.pipeTo(decoder.writable); 
                reader = decoder.readable.getReader();
                
                log("‚úÖ ESCUCHANDO PUERTO...");
                leerDatos();
            } catch (e) { log("‚ö†Ô∏è ERROR: " + e); }
        }

        // --- 2. BUCLE DE LECTURA ---
        async function leerDatos() {
            while (true) {
                try {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) procesarTexto(value);
                } catch (e) { 
                    log("Error lectura: " + e); 
                    break; 
                }
            }
        }

        // --- 3. PROCESAR DATOS (PARSER) ---
        let buffer = "";
        function procesarTexto(texto) {
            buffer += texto;
            let start = buffer.indexOf('<');
            let end = buffer.indexOf('>');
            
            while (start !== -1 && end !== -1) {
                if (end > start) {
                    let mensaje = buffer.substring(start + 1, end);
                    ejecutarComando(mensaje);
                    buffer = buffer.substring(end + 1);
                } else { 
                    buffer = buffer.substring(start); 
                }
                start = buffer.indexOf('<'); 
                end = buffer.indexOf('>');
            }
        }

        // --- 4. EJECUTAR ACCI√ìN ---
        function ejecutarComando(msg) {
            // Escribir en terminal siempre
            log("RX < " + msg); 

            // Si es el pulsador D3...
            if (msg === "D3:ON") {
                const led = document.getElementById("visual-btn");
                led.classList.add("active");
                // Apagar visualmente a los 200ms
                setTimeout(() => led.classList.remove("active"), 200);
            }
        }

        // --- 5. LOG ROBUSTO ---
        function log(msg) {
            const term = document.getElementById("terminal");
            const div = document.createElement("div");
            div.textContent = msg;
            term.appendChild(div);
            term.scrollTop = term.scrollHeight;
        }
    </script>
</body>
</html>