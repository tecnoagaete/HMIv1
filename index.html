<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>P1: LED Azul D13</title>
    <style>
        /* --- ESTILOS v3.34 (Mejorados) --- */
        :root { 
            --bg-body:#1a1a2e; --bg-card:#16213e; --text-main:#fff; --text-accent:#e94560; 
            --led-off:#444; --led-blue:#00d2ff; 
            --terminal-bg:#0f0f1a; --terminal-text:#00ff00; 
        }
        body { font-family:'Segoe UI', sans-serif; background:var(--bg-body); color:var(--text-main); text-align:center; padding:20px; }
        h1 { border-bottom:2px solid var(--text-accent); display:inline-block; padding-bottom:10px; }
        
        .grid-container { display:flex; justify-content:center; gap:20px; margin-top:20px; flex-wrap:wrap; }
        .card { background:var(--bg-card); border:1px solid #333; border-radius:12px; padding:20px; width:300px; display:flex; flex-direction:column; align-items:center; }
        
        button.btn-connect { background:var(--text-accent); color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold; width:100%; margin-bottom:10px; font-size:1rem; }
        button.btn-connect:hover { background: #ff577f; }

        /* Terminal mejorado para asegurar visibilidad */
        #terminal { 
            background:var(--terminal-bg); color:var(--terminal-text); 
            height:150px; width:100%; overflow-y:auto; 
            font-family:'Courier New', monospace; font-size: 0.9rem;
            text-align:left; padding:10px; box-sizing:border-box; border:1px solid #555; 
            white-space: pre-wrap; /* Mantiene saltos de l√≠nea */
        }

        .led-indicator { width:60px; height:60px; border-radius:50%; background:var(--led-off); border:3px solid #666; transition:0.2s; margin:20px; box-shadow:inset 0 0 10px #000; }
        .led-indicator.active { background:var(--led-blue); box-shadow:0 0 25px var(--led-blue); border-color:#fff; }
        
        .switch { position:relative; width:60px; height:30px; } .switch input { opacity:0; }
        .slider { position:absolute; top:0; left:0; right:0; bottom:0; background:#ccc; transition:.4s; border-radius:34px; cursor:pointer; }
        .slider:before { position:absolute; content:""; height:22px; width:22px; left:4px; bottom:4px; background:white; transition:.4s; border-radius:50%; }
        input:checked + .slider { background:var(--text-accent); } input:checked + .slider:before { transform:translateX(30px); }
    </style>
</head>
<body>

    <h1>Pr√°ctica 1: Control LED D13</h1>

    <div class="grid-container">
        
        <div class="card">
            <h3>üîå Conexi√≥n USB</h3>
            <button class="btn-connect" onclick="conectarArduino()">üîå CONECTAR</button>
            <div id="terminal">System Ready...</div>
        </div>

        <div class="card">
            <h3>üí° LED Azul (D13)</h3>
            <div id="led-visual" class="led-indicator"></div>
            
            <label class="switch">
                <input type="checkbox" id="sw-13" onchange="cambiarLed()">
                <span class="slider"></span>
            </label>
            <p style="font-size:0.8rem; color:#aaa; margin-top:10px;">Interruptor ON/OFF</p>
        </div>
    </div>

    <script>
        // Variables Globales
        let port;
        let writer;

        // --- 1. FUNCI√ìN DE CONEXI√ìN ROBUSTA ---
        async function conectarArduino() {
            // Verificar soporte
            if (!("serial" in navigator)) {
                log("‚ùå ERROR: Tu navegador no soporta Serial API. Usa Chrome.");
                return;
            }

            try {
                // Solicitar puerto
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });

                // Preparar el escritor (Writer)
                const textEncoder = new TextEncoderStream();
                const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
                writer = textEncoder.writable.getWriter();

                log("‚úÖ PUERTO ABIERTO CORRECTAMENTE");
                
            } catch (error) {
                console.error(error);
                log("‚ö†Ô∏è ERROR DE CONEXI√ìN: " + error);
            }
        }

        // --- 2. L√ìGICA DEL LED (Separada para depurar) ---
        function cambiarLed() {
            // A. Parte Visual (Web)
            const checkbox = document.getElementById("sw-13");
            const estado = checkbox.checked;
            const ledVisual = document.getElementById("led-visual");
            
            // Encender/Apagar visualmente
            if (estado) {
                ledVisual.classList.add("active");
                enviarComando("<D13:ON>"); // Mandar orden encender
            } else {
                ledVisual.classList.remove("active");
                enviarComando("<D13:OFF>"); // Mandar orden apagar
            }
        }

        // --- 3. ENV√çO DE DATOS (Con Logs forzados) ---
        async function enviarComando(texto) {
            // A. Primero escribimos en pantalla (Feedback inmediato)
            log("TX > " + texto);

            // B. Luego intentamos enviar al Arduino
            if (writer) {
                try {
                    await writer.write(texto + "\n");
                } catch (err) {
                    log("‚ùå ERROR ENVIANDO: " + err);
                }
            } else {
                log("‚ö†Ô∏è AVISO: No est√°s conectado al USB.");
            }
        }

        // --- 4. FUNCI√ìN LOG (A prueba de fallos) ---
        function log(mensaje) {
            const terminal = document.getElementById("terminal");
            
            // Crear una nueva l√≠nea de texto
            const nuevaLinea = document.createElement("div");
            nuevaLinea.textContent = mensaje;
            
            // A√±adir al terminal
            terminal.appendChild(nuevaLinea);
            
            // Auto-scroll hacia abajo
            terminal.scrollTop = terminal.scrollHeight;
        }
    </script>
</body>
</html>