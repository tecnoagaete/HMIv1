<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>P9: Sensor LDR</title>
    <style>
        /* --- ESTILOS ROBUSTOS v3.35 --- */
        :root { 
            --bg-body:#1a1a2e; --bg-card:#16213e; --text-main:#fff; --text-accent:#e94560; 
            --ldr-color:#ffc107; /* Amarillo Sol */
            --terminal-bg:#0f0f1a; --terminal-text:#00ff00; 
        }
        body { font-family:'Segoe UI', sans-serif; background:var(--bg-body); color:var(--text-main); text-align:center; padding:20px; }
        h1 { border-bottom:2px solid var(--text-accent); display:inline-block; padding-bottom:10px; }
        
        .grid-container { display:flex; justify-content:center; gap:30px; margin-top:30px; flex-wrap:wrap; }
        .card { background:var(--bg-card); border:1px solid #333; border-radius:12px; padding:20px; width:300px; display:flex; flex-direction:column; align-items:center; }
        
        button.btn-connect { background:var(--text-accent); color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold; width:100%; margin-bottom:10px; font-size:1rem; }
        button.btn-connect:hover { background: #ff577f; }

        #terminal { background:var(--terminal-bg); color:var(--terminal-text); height:150px; width:100%; overflow-y:auto; font-family:'Courier New', monospace; font-size: 0.9rem; text-align:left; padding:10px; border:1px solid #555; white-space: pre-wrap; }

        /* --- CORRECCI√ìN MATEM√ÅTICA DEL GR√ÅFICO --- */
        /* Radio del arco: 80px */
        /* Longitud del arco (PI * 80) = 251.3 px */
        /* Usaremos 252 para redondear */
        
        .gauge-svg { width: 220px; height: 120px; filter: drop-shadow(0 0 5px rgba(255, 193, 7, 0.3)); }
        
        .gauge-bg { 
            fill: none; 
            stroke: #444; 
            stroke-width: 15; 
            stroke-linecap: round; 
        }
        
        .gauge-progress { 
            fill: none; 
            stroke: var(--ldr-color); 
            stroke-width: 15; 
            stroke-linecap: round; 
            
            /* Longitud total corregida */
            stroke-dasharray: 252; 
            stroke-dashoffset: 252; /* Empieza vac√≠o */
            
            transition: stroke-dashoffset 0.3s ease-out; 
        }

        .icon-sun { font-size: 1.5rem; margin-top: 5px; opacity: 0.8; }
        .value-text { font-size:2.5rem; font-weight:bold; color:var(--ldr-color); font-family:monospace; margin-top:-10px; }
    </style>
</head>
<body>

    <h1>Pr√°ctica 9: Sensor de Luz (LDR)</h1>

    <div class="grid-container">
        <div class="card">
            <h3>üîå Conexi√≥n USB</h3>
            <button class="btn-connect" onclick="conectarArduino()">üîå CONECTAR</button>
            <div id="terminal">System Ready...</div>
        </div>

        <div class="card">
            <h3>‚òÄÔ∏è Sensor de Luz (A1)</h3>
            
            <svg class="gauge-svg" viewBox="0 0 220 120">
                <path class="gauge-bg" d="M 30 100 A 80 80 0 0 1 190 100" />
                
                <path id="ldr-fill" class="gauge-progress" d="M 30 100 A 80 80 0 0 1 190 100" />
                
                <text x="110" y="90" text-anchor="middle" fill="#888" font-size="12" font-family="sans-serif">LUZ</text>
            </svg>
            
            <div id="ldr-val" class="value-text">0%</div>
            <div class="icon-sun">‚òÄÔ∏è</div>
        </div>
    </div>

    <script>
        let port, reader;

        // --- 1. CONEXI√ìN ---
        async function conectarArduino() {
            if (!("serial" in navigator)) return log("‚ùå Navegador no compatible.");
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                const decoder = new TextDecoderStream(); 
                port.readable.pipeTo(decoder.writable); 
                reader = decoder.readable.getReader();
                
                log("‚úÖ LEYENDO SENSOR LUZ...");
                leerDatos();
            } catch (e) { log("‚ö†Ô∏è ERROR: " + e); }
        }

        // --- 2. BUCLE LECTURA ---
        async function leerDatos() {
            while (true) {
                try {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) procesarTexto(value);
                } catch (e) { log("Error lectura: " + e); break; }
            }
        }

        // --- 3. PARSEADO ---
        let buffer = "";
        function procesarTexto(texto) {
            buffer += texto;
            let start = buffer.indexOf('<');
            let end = buffer.indexOf('>');
            
            while (start !== -1 && end !== -1) {
                if (end > start) {
                    let mensaje = buffer.substring(start + 1, end);
                    ejecutarComando(mensaje);
                    buffer = buffer.substring(end + 1);
                } else { buffer = buffer.substring(start); }
                start = buffer.indexOf('<'); end = buffer.indexOf('>');
            }
        }

        // --- 4. VISUALIZACI√ìN ---
        function ejecutarComando(msg) {
            let parts = msg.split(':');
            
            if (parts[0] === "LDR") {
                let val = parseInt(parts[1]); // 0 a 100
                
                // Texto
                document.getElementById("ldr-val").innerText = val + "%";
                
                // C√ÅLCULO SVG CORREGIDO:
                // La longitud total del arco es 252
                // Si val=0% -> offset=252 (vac√≠o)
                // Si val=100% -> offset=0 (lleno)
                
                let maxLen = 252; 
                let offset = maxLen - ((val / 100) * maxLen);
                
                document.getElementById("ldr-fill").style.strokeDashoffset = offset;

                log("RX < LDR: " + val + "%");
            }
        }

        // --- 5. LOG ---
        function log(msg) {
            const term = document.getElementById("terminal");
            if (term.childElementCount > 50) term.removeChild(term.firstChild);
            const div = document.createElement("div");
            div.textContent = msg;
            term.appendChild(div);
            term.scrollTop = term.scrollHeight;
        }
    </script>
</body>
</html>